name: Auto-Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - "README.md"
      - "CHANGELOG.md"
      - "docs/**"
      - ".gitignore"

permissions:
  contents: write
  id-token: write

jobs:
  analyze-commits:
    runs-on: ubuntu-latest
    outputs:
      should-release: ${{ steps.check-version.outputs.should-release }}
      next-version: ${{ steps.check-version.outputs.next-version }}
      release-type: ${{ steps.check-version.outputs.release-type }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: latest-tag
        run: |
          # Get the latest tag, or use v0.0.0 if no tags exist
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest-tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
          echo "Latest tag: ${LATEST_TAG}"

      - name: Analyze commits since last release
        id: analyze
        run: |
          LATEST_TAG=${{ steps.latest-tag.outputs.latest-tag }}

          # Get all commits since the latest tag
          if [ "$LATEST_TAG" = "v0.0.0" ]; then
            COMMITS=$(git log --pretty=format:"%s" --no-merges)
          else
            COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"%s" --no-merges)
          fi

          echo "Commits since ${LATEST_TAG}:"
          echo "$COMMITS"

          # Check for breaking changes, features, and fixes
          HAS_BREAKING=$(echo "$COMMITS" | grep -E "^[a-z]+(\(.+\))?!:|BREAKING CHANGE" || true)
          HAS_FEATURE=$(echo "$COMMITS" | grep -E "^feat(\(.+\))?:" || true)
          HAS_FIX=$(echo "$COMMITS" | grep -E "^fix(\(.+\))?:" || true)

          echo "has-breaking=$([ -n "$HAS_BREAKING" ] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "has-feature=$([ -n "$HAS_FEATURE" ] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "has-fix=$([ -n "$HAS_FIX" ] && echo true || echo false)" >> $GITHUB_OUTPUT

      - name: Calculate next version
        id: check-version
        run: |
          LATEST_TAG=${{ steps.latest-tag.outputs.latest-tag }}
          HAS_BREAKING=${{ steps.analyze.outputs.has-breaking }}
          HAS_FEATURE=${{ steps.analyze.outputs.has-feature }}
          HAS_FIX=${{ steps.analyze.outputs.has-fix }}

          # Parse version
          VERSION=${LATEST_TAG#v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)

          # Determine next version
          RELEASE_TYPE="none"
          if [ "$HAS_BREAKING" = "true" ]; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            RELEASE_TYPE="major"
          elif [ "$HAS_FEATURE" = "true" ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
            RELEASE_TYPE="minor"
          elif [ "$HAS_FIX" = "true" ]; then
            PATCH=$((PATCH + 1))
            RELEASE_TYPE="patch"
          fi

          NEXT_VERSION="v${MAJOR}.${MINOR}.${PATCH}"

          echo "release-type=${RELEASE_TYPE}" >> $GITHUB_OUTPUT
          echo "next-version=${NEXT_VERSION}" >> $GITHUB_OUTPUT
          echo "should-release=$([ "$RELEASE_TYPE" != "none" ] && echo "true" || echo "false")" >> $GITHUB_OUTPUT

          echo "Release Type: ${RELEASE_TYPE}"
          echo "Next Version: ${NEXT_VERSION}"
          echo "Should Release: $([ "$RELEASE_TYPE" != "none" ] && echo "true" || echo "false")"

  create-release:
    needs: analyze-commits
    if: needs.analyze-commits.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'  # or your version

      - name: Get octo-sts token
        id: octo-sts
        uses: octo-sts/action@main
        with:
          scope: aaron-srivastava/substack-cli
          identity: release

      - name: Run go-semantic-release
        uses: go-semantic-release/action@v1
        with:
          allow-initial-development-versions: true
          hooks: goreleaser
        env:
          GITHUB_TOKEN: ${{ steps.octo-sts.outputs.token }}
